# 一个例子：Opteron的数据缓存

图B.5显示了AMD Opteron微处理器的数据缓存的组织结构。缓存包含65,536(64K)字节的数据，分为64字节的块，具有双路组相联，LRU替换，write-back，以及写未命中时的write allocate 。

![图B.5 Opteron微处理器中的数据高速缓存组织。 64KiB高速缓存是由64字节的块组成的双路组相联。9位索引在512组中进行选择。读取命中的四个步骤，按发生的顺序用圆圈表示，标明了这个组织顺序。块偏移量的3位与索引相连，以提供RAM地址来选择适当的8个字节。因此，高速缓存拥有两组4096个64位的字，每组包含512组的一半。虽然在这个例子中没有行使，但从低级别的内存到高速缓存的线路在未命中时被用来加载高速缓存。离开处理器的地址大小为40位，因为它是一个物理地址而不是一个虚拟地址。图B.24解释了Opteron是如何从虚拟地址映射到物理地址进行高速缓存访问的。](../../.gitbook/assets/NeatReader-1656833433564.png)

让我们通过图B.5中标注的步骤来追踪一个缓存的命中情况（四个步骤用圈起来的数字表示）。 如B.5节所述，Opteron向缓存提交了一个48位的虚拟地址用于标记比较，同时被转换为一个40位的物理地址。

Opteron没有使用全部64位的虚拟地址的原因是它的设计者认为还没有人需要那么多的虚拟地址空间，而且较小的尺寸可以简化Opteron的虚拟地址映射。设计者计划在未来的微处理器中增加虚拟地址。

进入缓存的物理地址分为两个字段：34位块地址和6位块偏移量（64=26，34+6=40）。块地址又被分为地址标签和缓冲区索引。步骤1显示了这种划分。

缓存索引选择要测试的标签，看所需的块是否在缓存中。索引的大小取决于缓冲区的大小，块的大小和集合关联性。对于Opteron高速缓存来说，集合关联性被设置为2，我们计算索引的方法如下。
